<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Toast UI Editor Modal Demo</title>

  <!-- Tailwind for quick layout -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Toast UI Editor (all-in-one) -->
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
  <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>

  <style>
  #editorContainer {
    display: flex;
    flex-direction: column;
    height: auto;              /* grows with content */
    min-height: 400px;
    resize: vertical;          /* user can resize vertically */
    overflow: auto;            /* enable scrollbars if resized too small */
  }

  .toastui-editor-defaultUI {
    flex: 1;
    display: flex;
    flex-direction: column;
  }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-6">

  <button id="openBtn" class="px-4 py-2 bg-blue-600 text-white rounded shadow">Open Toast UI Editor</button>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 z-50 hidden items-center justify-center">
    <!-- dialog -->
    <div class="bg-white rounded-lg shadow-lg w-full max-w-5xl mx-4 max-h-[90vh] flex flex-col">
      <div class="flex items-center justify-between p-4 border-b">
        <h3 class="text-lg font-semibold">Write Article</h3>
        <button id="closeBtn" class="text-gray-600">&times;</button>
      </div>

      <form id="form" class="p-4 flex-1 flex flex-col overflow-y-auto">
        <input id="title" placeholder="Article title" class="mb-3 p-2 border rounded w-full" />

        <!-- editor -->
        <div class="flex flex-col flex-1">
          <label class="text-sm mb-2">Editor</label>
          <div id="editorContainer" class="flex-1 border rounded"></div>
        </div>

        <div class="flex justify-end gap-2 mt-4">
          <button type="button" id="cancel" class="px-4 py-2 bg-gray-200 rounded">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Save</button>
        </div>
      </form>
    </div>
  </div>
<script>
  let editor = null;

  function openModal() {
    document.getElementById('modal').classList.remove('hidden');
    document.getElementById('modal').classList.add('flex');

    // init editor AFTER modal is visible
    setTimeout(() => {
      if (!editor) initToastEditor();
    }, 900);
  }

  function closeModal() {
    destroyToastEditor();
    document.getElementById('modal').classList.add('hidden');
    document.getElementById('modal').classList.remove('flex');
  }

  function initToastEditor() {
    // create the editor (Markdown + WYSIWYG)
    editor = new toastui.Editor({
      el: document.getElementById('editorContainer'),
      height: '100%',
      minHieght: '300px',
      initialEditType: '', // or 'markdown'
      previewStyle: window.innerWidth < 768 ? 'tab' : 'vertical',
      usageStatistics: false,
      hooks: {
        // image upload hook (example) - upload to server; here we insert base64 as fallback
        addImageBlobHook: (blob, callback) => {
          // Example: upload to your server with fetch and return URL to callback(url)
          // For demo, we'll convert to base64 and insert (not recommended for production)
          const reader = new FileReader();
          reader.onload = () => {
            callback(reader.result, 'uploaded-image');
          };
          reader.readAsDataURL(blob);
          return false; // handled async
        }
      }
    });

    // update preview initially
    updatePreview();

    // live update preview on change
    editor.on('change', () => {
      updatePreview();
    });
  }

  function destroyToastEditor() {
    if (editor) {
      editor.remove();
      editor = null;
    }
  }

  function updatePreview() {
    if (!editor) return;
    // you can get HTML or markdown
    const html = editor.getHTML();
    document.getElementById('preview').innerHTML = html;
  }

  // Button wiring
  document.getElementById('openBtn').addEventListener('click', openModal);
  document.getElementById('closeBtn').addEventListener('click', closeModal);
  document.getElementById('cancel').addEventListener('click', closeModal);

  document.getElementById('form').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!editor) return;

    const payload = {
      title: document.getElementById('title').value,
      html: editor.getHTML(),       // store HTML to DB
      markdown: editor.getMarkdown() // optional
    };

    console.log('Sending payload to backend:', payload);

    window.addEventListener('resize', () => {
  if (editor) {
    editor.setMarkdown(editor.getMarkdown()); // refresh rendering
    editor.changePreviewStyle(window.innerWidth < 768 ? 'tab' : 'vertical');
  }
});

    // Example POST to FastAPI (uncomment & adapt URL)
    /*
    try {
      const resp = await fetch('/api/news', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await resp.json();
      console.log('Saved:', data);
    } catch (err) {
      console.error('Save error', err);
    }
    */

    // For demo, just close modal after logging
    closeModal();
  });
</script>
</body>
</html>
